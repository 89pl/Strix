from typing import Any
from strix.agents.base_agent import BaseAgent
from strix.llm.config import LLMConfig

class ExploitAgent(BaseAgent):
    """
    ExploitAgent is a specialized security agent focused on continuous exploit discovery
    and validation using Metasploit, ExploitDB, and other security tools.
    """
    max_iterations = 500  # Exploitation can be intensive

    def __init__(self, config: dict[str, Any]):
        # ExploitAgent might have specific default skills or config
        default_skills = ["metasploit", "exploitdb"]
        
        # Ensure the agent uses its specialized system prompt
        if "system_prompt_path" not in config:
            import os
            current_dir = os.path.dirname(os.path.abspath(__file__))
            config["system_prompt_path"] = os.path.join(current_dir, "system_prompt.jinja")
            
        self.default_llm_config = LLMConfig(skills=default_skills)
        super().__init__(config)

    async def execute_scan(self, scan_config: dict[str, Any]) -> dict[str, Any]:
        """
        The ExploitAgent's job is typically triggered with specific exploit targets.
        """
        user_instructions = scan_config.get("user_instructions", "")
        targets = scan_config.get("targets", [])
        
        task_parts = ["CONTINOUSLY try to find and validate exploits on the following targets:"]
        
        for target in targets:
            target_type = target["type"]
            details = target["details"]
            if target_type == "web_application":
                task_parts.append(f"- URL: {details['target_url']}")
            elif target_type == "ip_address":
                task_parts.append(f"- IP: {details['target_ip']}")
            elif target_type == "repository":
                task_parts.append(f"- Repo: {details['target_repo']}")

        task_description = "\n".join(task_parts)
        if user_instructions:
            task_description += f"\n\nContext/Instructions: {user_instructions}"
            
        return await self.agent_loop(task=task_description)
